# GitHub Actions workflow for NetBox WUG Sync plugin
# Basic validation and code quality checks

name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    name: Basic Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Validate Python syntax
        run: |
          echo "Checking Python syntax for all .py files..."
          find netbox_wug_sync -name "*.py" -type f | while read file; do
            echo "Checking: $file"
            python -m py_compile "$file" || exit 1
          done
          echo "✅ All Python files have valid syntax"

      - name: Basic file structure validation
        run: |
          echo "Validating plugin structure..."
          
          # Check required files exist
          test -f "netbox_wug_sync/__init__.py" || { echo "❌ Missing __init__.py"; exit 1; }
          test -f "netbox_wug_sync/models.py" || { echo "❌ Missing models.py"; exit 1; }
          test -f "README.md" || { echo "❌ Missing README.md"; exit 1; }
          
          echo "✅ Plugin structure validation passed"

      - name: Version validation
        run: |
          python -c "
          import ast
          with open('netbox_wug_sync/__init__.py', 'r') as f:
              content = f.read()
          
          # Parse the file to extract version
          tree = ast.parse(content)
          for node in ast.walk(tree):
              if isinstance(node, ast.Assign):
                  for target in node.targets:
                      if isinstance(target, ast.Name) and target.id == '__version__':
                          if isinstance(node.value, ast.Constant):
                              print(f'Plugin version: {node.value.value}')
                              print('✅ Version extraction successful')
                              break
          
          print('✅ Basic validation successful')
          "

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
        continue-on-error: true

  results:
    name: Results
    runs-on: ubuntu-latest
    needs: [validate, security]
    if: always()
    steps:
      - name: Report results
        run: |
          echo "Validation: ${{ needs.validate.result }}"
          echo "Security: ${{ needs.security.result }}"
          if [ "${{ needs.validate.result }}" = "success" ]; then
            echo "✅ Basic validation passed"
            echo "✅ Repository is ready for public use"
          else
            echo "❌ Validation failed"
            exit 1
          fi