# GitHub Actions workflow for NetBox WUG Sync plugin
# Basic validation and code quality checks

name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    name: Basic Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install basic dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8

      - name: Validate Python syntax
        run: |
          python -m py_compile netbox_wug_sync/*.py
          find netbox_wug_sync -name "*.py" -exec python -m py_compile {} \;

      - name: Basic import test
        run: |
          python -c "
          import sys
          sys.path.insert(0, '.')
          try:
              from netbox_wug_sync import __version__
              print(f'Plugin version: {__version__}')
              print('✅ Basic import successful')
          except Exception as e:
              print(f'❌ Import failed: {e}')
              sys.exit(1)
          "

      - name: Run basic linting
        run: |
          flake8 netbox_wug_sync/ --count --select=E9,F63,F7,F82 --show-source --statistics || true

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
        continue-on-error: true

  notify:
    name: Results
    runs-on: ubuntu-latest
    needs: [validate, security]
    if: always()
    steps:
      - name: Report results
        run: |
          echo "Validation: ${{ needs.validate.result }}"
          echo "Security: ${{ needs.security.result }}"
          if [ "${{ needs.validate.result }}" = "success" ]; then
            echo "✅ Basic validation passed"
          else
            echo "❌ Validation failed"
          fi